var g_headers={"Accept-Charset":"windows-1251,utf-8;q=0.7,*;q=0.3","Accept-Language":"ru-RU,ru;q=0.8,en-US;q=0.6,en;q=0.4","User-Agent":"Mozilla/5.0 (Windows NT 6.1; Intel Mac OS X 10.6; rv:7.0.1) Gecko/20100101 Firefox/7.0.1",Connection:"keep-alive"},g_gwtCfg={url:"https://account.kyivstar.ua/cas/auth/",strong_name:"\\b%VARNAME_BROWSER%],(\\w+)\\)",auth_nocache:"auth.nocache.js",magic_id:"4AB5067AE5A0CF9B17498E816B1CF630"};function isLoggedIn(a){return/\/tbmb\/logout\/perform/i.test(a)}
function checkGwtError(a){try{return gwtGetJSON(a)}catch(d){if(/accountNotFound/i.test(d.message))throw new AnyBalance.Error("Пользователь с таким логином не найден!",null,!0);throw d;}}function initializeLogin(){var a=AnyBalance.getPreferences();checkEmpty(a.login,"Введите номер вашего телефона для входа в Мой Киевстар (в формате +380ХХХХХХХХХ), например +380971234567");checkEmpty(a.password,"Введите пароль!");AnyBalance.setOptions({SSL_ENABLED_PROTOCOLS:["TLSv1"]})}
function loginBasic(a){var d=AnyBalance.getPreferences(),b=AnyBalance.getLastUrl(),c=getElement(a,/<form[^>]+id="auth-form"[^>]*>/i);if(!c)throw AnyBalance.trace(a),new AnyBalance.Error("Не удалось найти форму входа. Сайт изменен?");var e=gwtLoadStrongName(g_gwtCfg);a=AnyBalance.requestPost(g_gwtCfg.url+"authSupport.rpc",makeReplaces("7|0|6|%url%|%magic_id%|ua.kyivstar.cas.shared.rpc.AuthSupportRPCService|getAccountShortDetails|java.lang.String/2004016611|%LOGIN%|1|2|3|4|1|5|6|",g_gwtCfg).replace(/%LOGIN%/g,
gwtEscape(d.login)),gwtHeaders(e,g_gwtCfg));if(checkGwtError(a)[7])throw new AnyBalance.Error("К сожалению, Киевстар потребовал ввода капчи для этого номера. Зайдите в личный кабинет один раз через браузер.",null,!0);var g={msisdn:"MSISDN_PASSWORD",fttb:"ACCOUNT_PASSWORD"},f=getParam(a,null,null,/"([^"]*)"\]/i,replaceSlashes);g[f]||(AnyBalance.trace("Неизвестный тип входа: "+f+"\n"+a),f=msisdn);a=AnyBalance.requestPost(g_gwtCfg.url+"authSupport.rpc",makeReplaces("7|0|7|%url%|%magic_id%|ua.kyivstar.cas.shared.rpc.AuthSupportRPCService|authenticate|java.lang.String/2004016611|%LOGIN%|%PASSWORD%|1|2|3|4|3|5|5|5|6|7|0|",
g_gwtCfg).replace(/%LOGIN%/g,gwtEscape(d.login.replace(/\D+/g,""))).replace(/%PASSWORD%/g,gwtEscape(d.password)),gwtHeaders(e,g_gwtCfg));checkGwtError(a);var h=getParam(a,null,null,/AuthResult[^"]*","([^"]*)/,replaceSlashes);if(!h)throw new AnyBalance.Error("Персональный пароль указан неверно!",null,!0);a=AB.createFormParams(c,function(a,b,c,e){return"username"==c?d.login.replace(/\D+/g,""):"password"==c?d.password:"authenticationType"==c?g[f]:"rememberMe"==c?"false":"token"==c?h:e});c=getParam(c,
null,null,/<form[^>]+action="([^"]*)/i,replaceHtmlEntities);a=AnyBalance.requestPost(joinUrl(b,c),a,addHeaders({Referer:b}));b=getParam(b,null,null,/https?:\/\/[^\/]*/i);if(0==AnyBalance.getLastUrl().indexOf(b))throw AnyBalance.trace("Переадресовали на "+AnyBalance.getLastUrl()+":\n"+a),new AnyBalance.Error("Не удалось зайти в личный кабинет. Сайт изменен?");return a}
function loginSite(a){var d=AnyBalance.getPreferences();initializeLogin();AnyBalance.trace("Логин на сайт.");a||(a="https://my.kyivstar.ua/");AnyBalance.trace("Соединение с "+a);var b=AnyBalance.requestGet(a+"tbmb/login/show.do",g_headers);if(!b||400<AnyBalance.getLastStatusCode())throw AnyBalance.trace(b),new AnyBalance.Error("Ошибка при подключении к сайту провайдера! Попробуйте обновить данные позже.");AnyBalance.trace("Успешное соединение.");isLoggedIn(b)&&(AnyBalance.trace("Уже в системе."),
0>b.indexOf(d.login)&&(AnyBalance.trace("Не тот аккаунт, выход."),AnyBalance.requestGet(a+"tbmb/logout/perform.do",g_headers),AnyBalance.trace("Переход на страницу входа."),b=AnyBalance.requestGet(a+"tbmb/login/show.do",g_headers)));isLoggedIn(b)||(b=loginBasic(b));if(!isLoggedIn(b)){if(a=getParam(b,null,null,/<td[^>]+class="(?:redError|casError)"[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,html_entity_decode))throw new AnyBalance.Error(a,null,/Перевірте правильність введення логіну|введіть правильний пароль/i.test(a));
if(/<form[^>]+action="[^"]*perform.do"/i.test(b))throw new AnyBalance.Error("Киевстар показал форму входа без ошибки. Возможно, вы пытаетесь войти в кабинет через мобильный интернет. На стороне Киевстара сейчас с этим проблема. Попробуйте обновить провайдер через вайфай.");AnyBalance.trace(b);throw new AnyBalance.Error("Не удалось зайти в систему. Сайт изменен?");}AnyBalance.trace("Успешный вход.");return b}
function loginMobile(a){initializeLogin();AnyBalance.trace("Логин в мобильное приложение.");a=AnyBalance.requestGet("https://account.kyivstar.ua/cas/login?locale=ru_ru&service=https://my.kyivstar.ua/tbmb/_assets_mobconv/portmone/index.html&renew=true&compact=1",g_headers);if(!a||400<AnyBalance.getLastStatusCode())throw AnyBalance.trace(a),new AnyBalance.Error("Ошибка при подключении к сайту провайдера! Попробуйте обновить данные позже.");AnyBalance.trace("Успешное соединение.");return a=loginBasic(a)}
;
