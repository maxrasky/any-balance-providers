var g_headers={Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8","Accept-Charset":"windows-1251,utf-8;q=0.7,*;q=0.3","Accept-Language":"ru-RU,ru;q=0.8,en-US;q=0.6,en;q=0.4",Connection:"keep-alive","User-Agent":"Mozilla/5.0 (Windows NT 6.1; WOW64; rv:35.0) Gecko/20100101 Firefox/35.0"},baseurl="https://online.rsb.ru/hb/faces/";
function login(){var b=AnyBalance.getPreferences();AnyBalance.setDefaultCharset("utf-8");var a=getProductsJson();if(a)AnyBalance.trace("Используем существующую сессию...");else{b=AnyBalance.requestPost(baseurl+"security_check",{j_username:b.login,j_password:b.password,systemid:"hb"},g_headers);(a=getParam(b,null,null,/window.location\s*=\s*"faces\/([^"]*)/i,replaceSlashes))&&(b=AnyBalance.requestGet(baseurl+a,g_headers));if(!/<div[^>]+class="b-login"[^>]*>/i.test(b))for(;/Ввод пароля из SMS-сообщения/i.test(b);){var a=
getParam(b,null,null,/<div[^>]+class="b-errors-message"[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces),e=getParam(b,null,null,/<label[^>]+for="temp_pass"[^>]*>([\s\S]*?)<\/label>/i,replaceTagsAndSpaces),e=a?a+"\n\n"+e:e+"\n\nДля пользования провайдером удобно отключить одноразовый пароль на вход в настройках интернет-банка. Это безопасно, для проведения любых операций SMS-пароль всё равно будет требоваться.",b=getParam(b,null,null,/<form[^>]+action="[^"]*sms.jsp[\s\S]*?<\/form>/i);if(!b)throw new AnyBalance.Error("Не удаётся найти форму ввода одноразового смс кода на вход.\n\nДля пользования провайдером удобно отключить одноразовый пароль на вход в настройках интернет-банка. Это безопасно, для проведения любых операций SMS-пароль всё равно будет требоваться.");
b=createFormParams(b,function(a,b,f,g){if(/submit_by_enth?er/i.test(b))return AnyBalance.retrieveCode(e,null,{time:3E5,inputType:"number"});if(/type="submit"/i.test(b))/&#1042;&#1086;&#1081;&#1090;&#1080;/.test(b)&&(a.source=f);else return g});b=AnyBalance.requestPost(baseurl+"system/login/sms/sms.jsp",b)}if(!/<div[^>]+class="b-login"[^>]*>/i.test(b)){if(a=getParam(b,null,null,/window.location\s*=\s*"([^"]*)/i,replaceSlashes))AnyBalance.trace("Переходим на "+a),b=AnyBalance.requestGet(joinUrl(baseurl,
a));if(/Ввод пароля из SMS-сообщения/i.test(b))throw new AnyBalance.Error("У вас настроен вход по паролю из SMS сообщения. Для пользования провайдером удобно отключить этот пароль в настройках интернет-банка. Это безопасно, для проведения любых операций SMS-пароль всё равно будет требоваться.");(a=getParam(b,null,null,/<div[^>]+class="b-frm-warning2"[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces))||(a=getParam(b,null,null,/<h2[^>]+class="b-auth-error[^>]*>([\s\S]*?)<\/h2>/i,replaceTagsAndSpaces));
a||(a=getParam(b,null,null,/<div[^>]+class="b-auth-blocked"[^>]*>\s*<p>([\s\S]*?)<\/p>/i,replaceTagsAndSpaces));/необходимо задать новый пароль/i.test(""+a)&&(a+=" Зайдите в интернет-банк https://online.rsb.ru через браузер, задайте новый пароль и введите новый пароль в настройки провайдера.");if(a)throw new AnyBalance.Error(a,null,/новый пароль|или пароль|Доступ в систему заблокирован/i.test(a));AnyBalance.trace(b);throw new AnyBalance.Error("Ошибка авторизации. Проверьте логин и пароль");}a=getProductsJson()}return a}
function getProductsJson(){if(getProductsJson.cached_json)return getProductsJson.cached_json;var b=AnyBalance.requestGet(baseurl+"request.json",g_headers);if(/'data'/.test(b))return!1;var a=getJson(b);if(!a.data)throw AnyBalance.trace(b),new AnyBalance.Error("Ошибка получения списка карт. Сайт изменен?");return getProductsJson.cached_json=a}
function processAccounts(b,a){if(AnyBalance.isAvailable("accounts")){for(var e=[],c=0;c<b.data.length;++c){var d=b.data[c];"account"==d.type&&e.push(d)}AnyBalance.trace("Найдено счетов: "+e.length);a.accounts=[];for(c=0;c<e.length;++c){var d=e[c],f=d.id,g=d.num,h=d.title+" "+g.substr(-4),f={__id:f,__name:h,num:g};__shouldProcess("accounts",f)&&processAccount(d,f);a.accounts.push(f)}}}
function processAccount(b,a){AnyBalance.trace("Обработка счета "+a.__name);getParam(b.title,a,"accounts.name");getParam(b.acc[0].available,a,"accounts.balance",null,null,parseBalance);getParam(b.acc[0].currency,a,["accounts.currency","accounts.balance"]);getParam(b.date_create,a,"accounts.date_start",null,null,parseDate);if(AnyBalance.isAvailable("accounts.transactions","accounts.status","accounts.tariff")){var e=AnyBalance.requestGet(joinUrl(baseurl,b.link),g_headers);if(AnyBalance.isAvailable("accounts.status",
"accounts.tariff")){var c=getElement(e,/<table[^>]+prod-balance_var2[^>]*>/i,replaceHtmlEntities);getParam(c,a,"accounts.status",/Состояние[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces);getParam(c,a,"accounts.tariff",/Тарифный план[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,[/Тарифный план\s*-/i,"",replaceTagsAndSpaces])}AnyBalance.isAvailable("accounts.transactions")&&processAccountTransactions(e,a)}}
function processCards(b,a){if(AnyBalance.isAvailable("cards")){for(var e=[],c=0;c<b.data.length;++c){var d=b.data[c];"card"==d.type&&e.push(d)}AnyBalance.trace("Найдено карт: "+e.length);a.cards=[];for(c=0;c<e.length;++c)if(d=e[c],d.acc){var f=d.id,g=d.num,h=d.title+" "+g.substr(-4),f={__id:f,__name:h,num:g};__shouldProcess("cards",f)&&processCard(d,f);a.cards.push(f)}}}function followDetailsLink(b,a){var e=getParam(b,null,null,a);if(e)return followDetailsLinkStr(b,e)}
function followDetailsLinkStr(b,a,e){var c=getElement(b,/<form[^>]+name="mainform"[^>]*>/i);b=createFormParams(c);b.source=getParam(a,null,null,/source\s*:\s*'([^']*)/);a=getParam(c,null,null,/<form[^>]+action="([^"]*)/i,replaceHtmlEntities);a=joinUrl(baseurl,a);return b=AnyBalance.requestPost(a,b,g_headers,e)}
function processCard(b,a){function e(a){return/основная/i.test(a)}AnyBalance.trace("Обработка карты "+a.__name);getParam(b.acc[0].available,a,"cards.balance",null,null,parseBalance);getParam(b.acc[0].lock,a,"cards.blocked",null,null,parseBalance);getParam(b.acc[0].own,a,"cards.own",null,null,parseBalance);getParam(b.acc[0].currency,a,["cards.currency","cards.balance","cards.blocked","cards.own"]);getParam(b.enddate,a,"cards.till",null,replaceTagsAndSpaces,parseDate);getParam(b.date_create,a,"cards.date_start",
null,replaceTagsAndSpaces,parseDate);getParam(b.tarif,a,"cards.tariff");var c=joinUrl(baseurl,b.link),c=AnyBalance.requestGet(c,g_headers),d=getElement(c,/<table[^>]+mb60[^>]*>/i,html_entity_decode);getParam(d,a,"cards.limit",/Лимит[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseBalance);AnyBalance.isAvailable("cards.transactions")&&processCardTransactions(c,a);AnyBalance.isAvailable("cards.accnum","cards.main","cards.status","cards.contract","cards.excerpt")&&(c=followDetailsLink(c,
/<table[^>]+prod-balance_var2[\s\S]*?(<a[^>]+link_more[^>]*>)/i),d=getElement(c,/<div[^>]+b-prod-props[^>]*>/i,replaceHtmlEntities),getParam(d,a,"cards.accnum",/Номер счета в банке:([\s\S]*?)<\/p>/i,replaceTagsAndSpaces),d=getElement(c,/<table[^>]+prod-balance_var2[^>]*>/i,replaceHtmlEntities),getParam(d,a,"cards.main",/>\s*Тип[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,e),getParam(d,a,"cards.status",/>\s*Статус[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces),getParam(d,a,"cards.contract",
/>\s*Договор[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,[/№/ig,"",replaceTagsAndSpaces]),getParam(d,a,"cards.gracepay",/Сумма для реализации Льготного периода[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseBalance),getParam(d,a,"cards.gracepay_till",/Дата окончания Льготного периода[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseDate),AnyBalance.isAvailable("cards.excerpt")&&processCardExerpt(c,a))}
function processDeposits(b,a){if(AnyBalance.isAvailable("deposits")){for(var e=[],c=0;c<b.data.length;++c){var d=b.data[c];"deposit"==d.type&&e.push(d)}AnyBalance.trace("Найдено депозитов: "+e.length);a.deposits=[];for(c=0;c<e.length;++c){var d=e[c],f=d.id,g=joinUrl(baseurl,d.link);AnyBalance.trace("Детали по депозиту находятся по ссылке "+g);var g=AnyBalance.requestGet(g,g_headers),h=AB.getElement(g,/<table[^>]+prod-balance_var2[^>]*>/,replaceHtmlEntities),k=getParam(h,null,null,/Номер депозитного счета[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,
replaceTagsAndSpaces),h=getParam(h,null,null,/Номер договора[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces),l=d.title+" "+k.substr(-4),f={__id:f,__name:l,num:k,contract:h};__shouldProcess("deposits",f)&&processDeposit(d,f,g);a.deposits.push(f)}}}
function processDeposit(b,a,e){AnyBalance.trace("Обработка депозита "+a.__name);getParam(b.acc[0].available,a,"deposits.balance",null,null,parseBalance);getParam(b.acc[0].currency,a,["deposits.currency","deposits.balance"]);getParam(b.date_create,a,"deposits.date_start",null,null,parseDate);getParam(b.end,a,"deposits.till",null,null,parseDate);getParam(b.rate,a,"deposits.pct",null,null,parseBalance);getParam(b.title,a,"deposits.name");b=AB.getElement(e,/<table[^>]+prod-balance_var2[^>]*>/,replaceHtmlEntities);
getParam(b,a,"deposits.prolong",/Автоматическое возобновление[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseBool);getParam(b,a,"deposits.prolong_times",/Количество свершившихся автоматических возобновлений[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseBalance)}
function processCredits(b,a){if(AnyBalance.isAvailable("credits")){for(var e=[],c=0;c<b.data.length;++c){var d=b.data[c];"loan"==d.type&&e.push(d)}AnyBalance.trace("Найдено кредитов: "+e.length);a.credits=[];for(c=0;c<e.length;++c){var d=e[c],f=d.id,g=d.num,h=d.title+" "+g.substr(-4),f={__id:f,__name:h,num:g};__shouldProcess("credits",f)&&processCredit(d,f);a.credits.push(f)}}}function parseBool(b){return/включено/i.test(b)}
function processCredit(b,a){AnyBalance.trace("Обработка кредита "+a.__name);getParam(b.loan.amount,a,"credits.limit",null,replaceTagsAndSpacesAndBalances,parseBalance)}
function processInfo(b,a){if(AnyBalance.isAvailable("info")){b=AnyBalance.requestGet(baseurl+"rs/settings/Settings.jspx",g_headers);var e=a.info={};getParam(b,e,"info.fio",/&#1048;&#1084;&#1103; ([^<]*)/i,replaceTagsAndSpaces);getParam(b,e,"info.login",/<input[^>]+name="mainform:login"[^>]*value="([^"]*)/i,replaceHtmlEntities);getParam(b,e,"info.email",/<input[^>]+name="mainform:email"[^>]*value="([^"]*)/i,replaceHtmlEntities)}};
