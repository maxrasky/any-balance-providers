var g_api_headers={"User-Agent":"MLK Android Phone 1.2.1",Connection:"Keep-Alive"},g_headers={Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8","Accept-Charset":"windows-1251,utf-8;q=0.7,*;q=0.3","Accept-Language":"ru-RU,ru;q=0.8,en-US;q=0.6,en;q=0.4",Connection:"keep-alive","User-Agent":"Mozilla/5.0 (Windows NT 6.1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/29.0.1547.76 Safari/537.36"},api_url="https://api.megafon.ru/mlk/",replaceNumber=[replaceTagsAndSpaces,/\D/g,"",/.*(\d\d\d)(\d\d\d)(\d\d)(\d\d)$/,
"+7 $1 $2-$3-$4"];function callAPI(a,b,c,f){a="post"==a?"string"==typeof c?AnyBalance.requestPost(api_url+b,c,addHeaders({"Content-Type":"application/json; charset=utf-8"},g_api_headers)):AnyBalance.requestPost(api_url+b,c,g_api_headers):AnyBalance.requestGet(api_url+b,g_api_headers);var e;try{e=getJson(a)}catch(g){e=getJsonEval(a)}if(e.code&&!f)throw new AnyBalance.Error("Ошибка вызова API! "+e.message);return e}
function megafonLkAPILogin(a){var b=AnyBalance.getPreferences();AnyBalance.setDefaultCharset("utf-8");checkEmpty(b.login&&/^\d{10}$/.test(b.login),"Введите 10 цифр номера телефона без пробелов и разделителей в качестве логина!");AnyBalance.trace("Пробуем войти через API мобильного приложения...");var c=AnyBalance.getCookie("JSESSIONID");c&&AnyBalance.setCookie("api.megafon.ru","JSESSIONID",c);c=AnyBalance.requestGet("http://api.megafon.ru/mlk/auth/check",g_api_headers);if(400<=AnyBalance.getLastStatusCode())throw AnyBalance.trace(c),
new AnyBalance.Error("Сервер мобильного API временно недоступен.");c=getJson(c);c.authenticated&&(AnyBalance.trace("Уже авторизованы на номер "+c.phone),c.phone!=b.login?(AnyBalance.trace("Номер неправильный (надо "+b.login+"), придется авторизоваться заново"),c.authenticated=!1):AnyBalance.trace("Номер правильный, используем текущую сессию"));if(!c.authenticated){c=callAPI("post","login",{login:b.login,password:b.password},!0);if(c.code&&("a211"==c.code&&a.allow_captcha&&(a=AnyBalance.requestGet(api_url+
"auth/captcha",g_api_headers),a=AnyBalance.retrieveCode("Мегафон иногда требует подтвердить, что вы не робот. Сейчас как раз такой случай. Если вы введете цифры с картинки, то мы сможем получить какую-то информацию помимо баланса. В противном случае получим только баланс.\n\nВы можете отключить показ капчи совсем или только ночью в настройках провайдера.",a,{inputType:"number"}),c=callAPI("post","login",{login:b.login,password:b.password,captcha:a})),c.code))throw new AnyBalance.Error("Ошибка вызова API! "+
c.message,null,/Неправильный логин\/пароль/i.test(c.message));__setLoginSuccessful()}}
function megafonLkAPIDo(a,b){AnyBalance.isAvailable("phone","balance","bonus_balance","tariff","credit")&&(json=callAPI("get","api/main/info"),getParam(json.msisdn,b,"phone",null,replaceNumber),getParam(json.originalBalance+"",b,"balance",null,replaceTagsAndSpaces,parseBalance),getParam(json.bonusBalance+"",b,"bonus_balance",null,replaceTagsAndSpaces,parseBalance),getParam(json.balance-json.originalBalance+"",b,"credit",null,replaceTagsAndSpaces,parseBalance),json.ratePlan&&getParam(json.ratePlan.name,
b,"tariff",null,replaceTagsAndSpaces));processRemaindersApi(b);processMonthExpensesApi(b);processPaymentsApi(b);if(AnyBalance.isAvailable("sub_scl"))try{json=callAPI("get","api/payments/info"),getParam(json.outcome+"",b,"sub_scl",null,replaceTagsAndSpaces,parseBalance)}catch(c){AnyBalance.trace("Ошибка получения информации о звонках: "+c.message+"\n"+c.stack)}processInfoApi(b);AnyBalance.isAvailable("detalization")&&processDetalizationApi(b);a.dontTurnOffSms||processSmsTurnOffApi()}
function processPaymentsApi(a){if(AnyBalance.isAvailable("payments"))try{var b=callAPI("get","api/payments/history?offset=0&size=10",!0);if(b.payments){a.payments=[];for(var c=0;c<b.payments.length;c++){var f=b.payments[c],e={};getParam(f.amount,e,"payments.sum");getParam(f.date,e,"payments.date",null,null,parseDate);getParam(f.descr,e,"payments.descr");a.payments.push(e)}}else AnyBalance.trace("Не удалось получить историю платежей: "+JSON.stringify(b))}catch(g){AnyBalance.trace("Ошибка получения истории платежей: "+
g.message+"\n"+g.stack)}}
function processMonthExpensesApi(a){if(AnyBalance.isAvailable("month_expenses"))try{var b=callAPI("get","api/reports/months",!0);if(b.expenseMonths){a.month_expences=[];for(var c=0;c<b.expenseMonths.length;c++){var f=b.expenseMonths[c],e={};getParam(f.amount,e,"month_expences.sum");getParam(f.reportDate,e,"month_expences.date",null,null,parseDate);getParam(f.percent,e,"month_expences.pct");a.month_expences.push(e)}}else AnyBalance.trace("Не удалось получить историю месячных трат: "+JSON.stringify(b))}catch(g){AnyBalance.trace("Ошибка получения истории месячных трат: "+
g.message+"\n"+g.stack)}}
function processRemaindersApi(a){if(AnyBalance.isAvailable("remainders")){var b=callAPI("get","api/options/remainders");a=a.remainders={};for(var c=[],f=b.models.length-1;0<=f;f--){var e=b.models[f],g=e.remainders&&e.remainders[0]&&e.remainders[0].optionId;if(0<=c.indexOf(e.name+g)&&/OPTION/i.test(e.optionsRemaindersType))AnyBalance.trace("Мы уже обработали пакеты опций из группы "+e.name),AnyBalance.trace(JSON.stringify(e));else if(e.remainders)for(c.push(e.name+g),g=0;g<e.remainders.length;g++){var d=
e.remainders[g],h=d.name,k=d.unit;if(0>d.available)AnyBalance.trace("Игнорируем отрицательные остатки..."+JSON.stringify(d));else if(/мин/i.test(k))AnyBalance.trace("Parsing minutes..."+JSON.stringify(d)),getParam(d.available,null,null,null,replaceTagsAndSpaces,parseBalance),/бесплат/i.test(h)?getParam(d.available,a,"remainders.mins_n_free",null,replaceTagsAndSpaces,parseMinutes):/\.\s*МегаФон|на мегафон/i.test(h)&&!/МТС/i.test(h)||/внутри сети/i.test(h)?sumParam(d.available,a,"remainders.mins_net_left",
null,replaceTagsAndSpaces,parseMinutes,aggregate_sum):(sumParam(d.available,a,"remainders.mins_left",null,replaceTagsAndSpaces,parseMinutes,aggregate_sum),sumParam(d.total,a,"remainders.mins_total",null,replaceTagsAndSpaces,parseMinutes,aggregate_sum));else if(/шт|sms|смс|mms|ммс/i.test(k))/mms|ММС/i.test(h)?(AnyBalance.trace("Parsing mms..."+JSON.stringify(d)),sumParam(d.available,a,"remainders.mms_left",null,replaceTagsAndSpaces,parseBalance,aggregate_sum),sumParam(d.total,a,"remainders.mms_total",
null,replaceTagsAndSpaces,parseBalance,aggregate_sum)):(AnyBalance.trace("Parsing sms..."+JSON.stringify(d)),sumParam(d.available,a,"remainders.sms_left",null,replaceTagsAndSpaces,parseBalance,aggregate_sum),sumParam(d.total,a,"remainders.sms_total",null,replaceTagsAndSpaces,parseBalance,aggregate_sum));else if(/([kmgкмгт][бb]?|[бb](?![\wа-я])|байт|byte)/i.test(k))if(AnyBalance.trace("Parsing data..."+JSON.stringify(d)),/Гигабайт в дорогу/i.test(h))getParam(d.available+d.unit,a,"remainders.gb_with_you",
null,replaceTagsAndSpaces,parseTraffic);else{k="";/ноч/i.test(h)&&(k="_night");var h=/^9{7,}$/i.test(d.total),l=getParam(d.available+d.unit,null,null,null,replaceTagsAndSpaces,parseTraffic),m=getParam(d.total+d.unit,null,null,null,replaceTagsAndSpaces,parseTraffic);isset(l)&&!h&&sumParam(l,a,"remainders.internet_left"+k,null,null,null,aggregate_sum);isset(m)&&!h&&sumParam(m,a,"remainders.internet_total"+k,null,null,null,aggregate_sum);isset(l)&&isset(m)&&sumParam(m-l,a,"remainders.internet_cur"+k,
null,null,null,aggregate_sum);d.dateTo?sumParam(d.dateTo,a,"remainders.internet_till",null,replaceTagsAndSpaces,parseDate,aggregate_min):d.dateFrom&&d.monthly&&sumParam(d.dateFrom,a,"remainders.internet_till",null,replaceTagsAndSpaces,function(a){if(a=parseDate(a))a=new Date(a),a=(new Date(a.getFullYear(),a.getMonth()+1,a.getDate(),a.getHours(),a.getMinutes(),a.getSeconds())).getTime();return a},aggregate_min)}else AnyBalance.trace("Неизвестные единицы измерений: "+k+" опция: "+h+": "+JSON.stringify(d))}}}}
function processInfoApi(a){if(AnyBalance.isAvailable("info")){AnyBalance.trace("Получаем инфо");var b=callAPI("get","api/profile/info");a=a.info={};getParam(b.contractStart,a,"info.time_start",null,null,parseDate);getParam(b.email,a,"info.email");getParam(b.name,a,"info.fio");getParam(b.region.id,a,"info.region_id");getParam(b.region.name,a,"info.region_name")}}
function processSmsTurnOffApi(){try{var a=callAPI("get","api/profile/info");a.notifications?(AnyBalance.trace("Включено смс оповещение о входе, отключаем..."),a=callAPI("post","api/profile/notifications?status=false"),AnyBalance.trace("Отключили, проверяем..."),a=callAPI("get","api/profile/info"),a.notifications?AnyBalance.trace("Не удалось отключить смс оповещение о входе в кабинет. Свяжитесь с разработчиком."):AnyBalance.trace("Успешно отключили смс оповещение о входе в кабинет!")):AnyBalance.trace("Cмс оповещение о входе в кабинет уже отключено!")}catch(b){AnyBalance.trace("Отключение смс не удалось: "+
b.message)}};
